# Go Reference CodeLens Extension

## Overview
Implement a lightweight VS Code extension that adds reference count and "go to definition" CodeLens functionality to Go files. The extension will leverage the existing Go extension's gopls instance to provide inline reference counts and quick navigation for functions, methods, interfaces, and exported struct fields.

## Problem Statement
The default Go extension hides useful CodeLens capabilities that gopls already provides. Developers need quick access to reference counts and definition navigation without manually invoking commands or spawning additional language server processes.

## Proposed Solution
Create a VS Code extension that:
1. Adds reference count CodeLens for every function, method, interface, and exported struct field
2. Provides "Go to definition" CodeLens on the same symbols
3. Reuses the existing Go extension's running gopls instance (no embedded server)
4. Maintains lightweight footprint with minimal dependencies

## Technical Requirements

### Core Features
| Feature | Implementation | VS Code API Hook |
|---------|----------------|------------------|
| Reference Count CodeLens | Call `textDocument/references` via Go extension's LanguageClient | `registerCodeLensProvider` with `extension.showRefs` command |
| Go to Definition CodeLens | Call `textDocument/definition` and invoke `revealDefinition` | Same provider with `editor.action.revealDefinition` command |
| No Embedded gopls | Reuse Go extension's running language server via exported API | `vscode.extensions.getExtension('golang.go')?.exports` |

### Architecture Decisions
- **No Embedded gopls**: Leverage existing Go extension's language server
- **Bun v1+ Toolchain**: Fast scripting and testing
- **Mirror retab Project Structure**: Consistent workflow with existing projects

## Implementation Plan

### 1. Repository Bootstrap
- Clone `github.com/walteh/retab` for reference structure
- Copy boilerplate: `package.json`, `tsconfig.json`, `.vscode/launch.json`, `Taskfile.yml`
- Create fresh repo: `walteh/goref-codelens`
- Prune formatter-specific logic, keep activation code

### 2. Directory Structure
```
goref-codelens/
├─ src/
│  ├─ extension.ts          # activation/registration
│  ├─ lenses.ts             # CodeLensProvider implementation
│  └─ util.ts               # reference/definition query helpers
├─ test/
│  ├─ sample/hello.go       # fixture files
│  └─ extension.test.ts     # Bun-driven integration tests
├─ Taskfile.yml
├─ bun.lockb
└─ package.json
```

### 3. Package Configuration
```json
{
  "scripts": {
    "build": "bun run tsc -p .",
    "watch": "bun run tsc -w",
    "test":  "bun test",
    "lint":  "bunx eslint . --ext .ts"
  },
  "devDependencies": {
    "@types/vscode": "^1.89.0",
    "typescript": "^5.5.0",
    "eslint": "^9.0.0",
    "@vscode/test-electron": "^2.4.2"
  }
}
```

### 4. Taskfile Configuration
```yaml
version: "3"

tasks:
  build:
    cmds: ["bun run build"]
  test:
    cmds: ["bun run test"]
  watch:
    cmds: ["bun run watch"]
```

## Implementation Details

### Extension Activation
```typescript
// Key functionality:
- Activate Go extension and obtain API
- Register CodeLensProvider for Go files
- Register command handlers for reference display
- Fallback to executeProvider commands if API unavailable
```

### GoRefLensProvider
```typescript
// Core logic:
- Query document symbols via executeDocumentSymbolProvider
- Filter supported kinds (Function, Method, Interface, Field)
- Execute reference provider for each symbol
- Create CodeLens with reference count and definition navigation
- Return lens array for VS Code rendering
```

### LSP Integration
- **Primary**: Direct LSP requests through Go extension's language client
- **Fallback**: VS Code's built-in `execute*Provider` commands
- **Supported Symbols**: Functions, Methods, Interfaces, Exported Fields

## Testing Strategy

### Integration Tests
- Use `@vscode/test-electron` for isolated VS Code instance
- Install Go extension + this extension in test environment
- Fixture Go files in `test/sample/`
- Assert CodeLens resolution and content

### Test Examples
```typescript
expect(await lensTitle('hello.go', 'main')).toBe('1 refs');
expect(await lensTitle('hello.go', 'Greeter')).toMatch(/definition/);
```

### Test Runner
- Bun's built-in Jest-compatible test runner
- Cross-platform compatibility
- Fast execution with minimal overhead

## CI/CD Pipeline

| Stage | Tool | Environment |
|-------|------|-------------|
| Build + Unit Tests | GitHub Actions | ubuntu-latest |
| Integration Tests | vscode-test | Matrix of VS Code versions |
| Packaging | vsce | Marketplace publication via PAT |

## Dependencies
- VS Code Extension API (^1.89.0)
- Go Extension (golang.go)
- TypeScript (^5.5.0)
- Bun (v1+)
- ESLint (^9.0.0)
- @vscode/test-electron (^2.4.2)

## Success Criteria
1. Reference counts display correctly on all supported symbols
2. "Go to definition" navigation works seamlessly
3. No additional gopls processes spawned
4. Fast CodeLens resolution with minimal latency
5. Comprehensive test coverage
6. CI/CD pipeline validates functionality

## Risk Mitigation

### Potential Issues & Solutions
- **No Go Extension API**: Fallback to `execute*Provider` commands
- **Large File Performance**: Implement throttling with `setTimeout` batching
- **gopls Version Compatibility**: Rely on user's installed binary
- **CodeLens Resolution Delays**: Respect VS Code's `codeLens/resolve` flow

## Deliverables Checklist
1. ✅ Scaffold repository structure
2. ✅ Implement `extension.ts`, `lenses.ts`, `util.ts`
3. ✅ Write comprehensive tests with Bun + VS Code test runner
4. ✅ Configure `package.json` contributions (activation events, commands, settings)
5. ✅ Create documentation (README.md, usage, settings)
6. ✅ Setup CI/CD pipeline
7. ✅ Create PR with `feat/initial-codelens` branch

## Configuration Options
- `goref.codeLens.enabled`: Enable/disable CodeLens functionality
- Custom keybindings for reference navigation
- Reference count display format options

## Future Enhancements
- Support for additional symbol types
- Configurable CodeLens display options
- Performance optimizations for large codebases
- Integration with other Go development tools

## References
- [VS Code CodeLens API Documentation](https://code.visualstudio.com/api/language-extensions/programmatic-language-features#codelens-show-actionable-context-information-within-source-code)
- [Go Extension API Documentation](https://github.com/golang/vscode-go)
- [Microsoft CodeLens Sample](https://github.com/microsoft/vscode-extension-samples/tree/main/codelens-sample)
- [gopls Language Server Protocol](https://github.com/golang/tools/tree/master/gopls) 