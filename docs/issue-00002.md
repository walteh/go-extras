# Go Reference CodeLens Extension Enhancements

## Overview

The `go-extras` VS Code extension already provides reference count and "go to definition" CodeLens functionality for Go files. This document outlines planned enhancements to expand the existing capabilities, improve performance, and add new features while leveraging the existing Go extension's gopls instance.

## Current Implementation Status

The base CodeLens functionality is implemented in `editors/vscode/src/extension.ts` with:

-   Reference count CodeLens for functions, methods, interfaces, and exported struct fields
-   "Go to definition" CodeLens on the same symbols
-   Integration with the existing Go extension's gopls instance
-   Configurable settings for enabling/disabling features

## Planned Enhancements

### 1. Advanced Symbol Support

Expand CodeLens coverage to additional Go constructs:

-   **Type Aliases**: Show usage count for type aliases
-   **Constants**: Reference tracking for exported constants
-   **Variables**: Usage tracking for package-level variables
-   **Embedded Fields**: Reference counts for embedded struct fields
-   **Generic Type Parameters**: Usage tracking in generic functions/types

### 2. Enhanced Reference Analysis

Improve the depth and accuracy of reference counting:

-   **Cross-Package References**: Include references from other modules
-   **Test File Correlation**: Separate counts for production vs test usage
-   **Exported vs Internal**: Distinguish between public API usage and internal references
-   **Documentation References**: Include references in comments and documentation

### 3. Performance Optimizations

Leverage the existing WASM infrastructure for better performance:

```typescript
// Enhanced CodeLens with WASM-powered analysis
export class AdvancedCodeLensProvider extends GoExtrasCodeLensProvider {
	private analyzer: ReferenceAnalyzer;

	constructor(outputChannel: vscode.OutputChannel) {
		super();
		this.analyzer = new ReferenceAnalyzer(outputChannel);
	}

	async provideCodeLenses(document: vscode.TextDocument): Promise<vscode.CodeLens[]> {
		// Use WASM for fast symbol analysis
		const symbols = await this.analyzer.analyzeSymbols(document.getText());
		return this.createCodeLensesFromSymbols(symbols);
	}
}

// WASM-powered reference analyzer
export class ReferenceAnalyzer extends GenericWasmWrapper {
	constructor(outputChannel: vscode.OutputChannel) {
		const config: WasmConfig = {
			moduleName: "reference-analyzer",
			wasmFileName: "reference-analyzer.wasm",
			extensionId: "walteh.go-extras",
		};
		super(outputChannel, config);
	}

	async analyzeSymbols(content: string): Promise<SymbolReference[]> {
		return this.callFunction("analyzeReferences", content);
	}
}
```

### 4. Interactive CodeLens Features

Add interactive capabilities to existing CodeLens:

-   **Reference Filtering**: Click to filter references by type, package, or test status
-   **Usage Heatmap**: Visual indicators showing reference frequency over time
-   **Dependency Graph**: Show symbol relationships and dependencies
-   **Refactoring Hints**: Suggest refactoring opportunities based on usage patterns

### 5. Integration Enhancements

Improve integration with other extension features:

```typescript
// Integration with debug functionality
export class IntegratedCodeLensProvider extends AdvancedCodeLensProvider {
	async resolveCodeLens(codeLens: vscode.CodeLens): Promise<vscode.CodeLens> {
		const baseResolved = await super.resolveCodeLens(codeLens);

		// Add debug context if available
		const debugInfo = await this.getDebugContext(codeLens.range);
		if (debugInfo) {
			baseResolved.command!.title += ` (${debugInfo.hitCount} debug hits)`;
		}

		return baseResolved;
	}
}
```

## Enhanced Project Structure

The existing structure will be expanded to support new features:

```
editors/vscode/src/
├── extension.ts              # Main extension - enhanced activation
├── codelens/                 # Reorganized CodeLens functionality
│   ├── provider.ts          # Main CodeLens provider (existing functionality)
│   ├── advanced.ts          # Advanced CodeLens features
│   ├── interactive.ts       # Interactive CodeLens capabilities
│   └── analyzer.ts          # WASM-powered analysis
├── debug/                   # Debug integration (from issue-00001)
│   ├── debugProvider.ts
│   └── shimLauncher.ts
├── wasm.ts                  # Generic WASM wrapper (existing)
└── wasm-examples.ts         # WASM usage examples (existing)
```

## Configuration Enhancements

Extend the existing configuration in `package.json`:

```json
{
	"configuration": {
		"title": "Go Extras",
		"properties": {
			"go-extras.codeLens.enabled": {
				"type": "boolean",
				"default": true,
				"description": "Enable CodeLens functionality"
			},
			"go-extras.codeLens.showReferences": {
				"type": "boolean",
				"default": true,
				"description": "Show reference count CodeLens"
			},
			"go-extras.codeLens.showDefinitions": {
				"type": "boolean",
				"default": true,
				"description": "Show go to definition CodeLens"
			},
			"go-extras.codeLens.advanced.crossPackage": {
				"type": "boolean",
				"default": false,
				"description": "Include cross-package references (performance impact)"
			},
			"go-extras.codeLens.advanced.testSeparation": {
				"type": "boolean",
				"default": true,
				"description": "Separate test and production reference counts"
			},
			"go-extras.codeLens.advanced.showHeatmap": {
				"type": "boolean",
				"default": false,
				"description": "Show usage heatmap indicators"
			},
			"go-extras.codeLens.interactive.enabled": {
				"type": "boolean",
				"default": true,
				"description": "Enable interactive CodeLens features"
			}
		}
	}
}
```

## Performance Considerations

### WASM-Powered Analysis

Leverage the existing WASM infrastructure to:

-   **Parallel Processing**: Analyze multiple files concurrently
-   **Incremental Updates**: Only re-analyze changed symbols
-   **Caching Strategy**: Cache reference counts across sessions
-   **Debounced Updates**: Batch CodeLens updates to reduce flicker

### Memory Management

Implement efficient memory usage:

-   **Symbol Index**: Maintain in-memory symbol database
-   **Reference Cache**: Cache expensive cross-package lookups
-   **Cleanup Routines**: Periodic cleanup of stale data

## Testing Strategy

### Enhanced Test Suite

Extend the existing test structure:

```
editors/vscode/test/
├── suite/
│   ├── extension.test.ts           # Existing extension tests
│   ├── codelens.test.ts           # Basic CodeLens tests (existing)
│   ├── codelens-advanced.test.ts  # Advanced CodeLens features
│   ├── codelens-performance.test.ts # Performance regression tests
│   └── integration.test.ts        # Integration with debug features
└── fixtures/
    ├── sample_test.go             # Existing test fixtures
    ├── cross-package/             # Multi-package test scenarios
    │   ├── pkg1/
    │   └── pkg2/
    └── large-codebase/            # Performance test fixtures
```

### Performance Benchmarks

Establish performance baselines:

-   **CodeLens Resolution Time**: Target <100ms per file
-   **Memory Usage**: Stay under 50MB for large codebases
-   **Update Frequency**: Minimize unnecessary updates

## Implementation Phases

### Phase 1: Enhanced Symbol Support (4-6 weeks)

-   [ ] Extend symbol detection to type aliases, constants, variables
-   [ ] Implement test/production reference separation
-   [ ] Add configuration options for new features
-   [ ] Update existing tests and add new test coverage

### Phase 2: WASM Performance Integration (3-4 weeks)

-   [ ] Implement WASM-powered reference analyzer
-   [ ] Add caching and incremental update strategies
-   [ ] Performance testing and optimization
-   [ ] Integration with existing WASM infrastructure

### Phase 3: Interactive Features (4-5 weeks)

-   [ ] Implement interactive CodeLens capabilities
-   [ ] Add reference filtering and heatmap features
-   [ ] Integrate with debug functionality from issue-00001
-   [ ] User experience testing and refinement

### Phase 4: Advanced Analysis (5-6 weeks)

-   [ ] Cross-package reference tracking
-   [ ] Dependency graph visualization
-   [ ] Refactoring hint suggestions
-   [ ] Documentation and examples

## Success Metrics

### Functional Requirements

1. **Backward Compatibility**: All existing CodeLens features continue to work
2. **Performance**: Enhanced features don't impact core functionality
3. **Configurability**: Users can enable/disable features as needed
4. **Integration**: Seamless integration with debug functionality
5. **Accuracy**: Reference counts remain accurate with new symbol types

### Quality Metrics

-   **Test Coverage**: Maintain >90% test coverage
-   **Performance**: <50ms additional overhead for enhanced features
-   **Memory Usage**: <25% increase in memory footprint
-   **User Adoption**: Positive feedback on new interactive features

## Future Roadmap

### Advanced Features

-   **AI-Powered Insights**: Use language models to suggest code improvements
-   **Code Quality Metrics**: Integration with linting and static analysis
-   **Documentation Generation**: Auto-generate documentation based on usage patterns
-   **Team Collaboration**: Share reference insights across development teams

### Tool Integration

-   **Git Integration**: Show reference changes over commits
-   **CI/CD Integration**: Reference count validation in pipelines
-   **Monitoring Integration**: Production usage tracking for API surfaces
-   **Documentation Tools**: Integration with godoc and other documentation tools

This enhanced roadmap builds upon the solid foundation already established in the `go-extras` extension while adding powerful new capabilities that maintain the lightweight, performant characteristics that make the extension valuable to Go developers.
