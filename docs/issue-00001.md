# Go Debug Extension: Cross-Boundary Debugging for Containerd Shim

## Overview

Implement a lightweight VS Code companion extension that enhances the existing Go debugging workflow. When you click "Debug Test", the extension automatically launches the containerd shim under a headless Delve server and spawns a nested remote-attach debug session, providing unified debugging across test binary and shim code boundaries.

## Problem Statement

Currently, debugging Go tests that interact with containerd shims requires:

-   Manual setup of multiple debug sessions
-   Complex configuration management
-   Separate debugging contexts for test code and shim code
-   No unified view of the call stack across boundaries

## Proposed Solution

Create a VS Code extension that:

1. Launches containerd shim under a headless `dlv --accept-multiclient` server
2. Automatically spawns a nested "remote-attach" debug session
3. Displays both stacks (test binary + shim) in unified tree view
4. Requires no changes to existing Go extension workflow

## Technical Architecture

### Key Integration Points

| Component                      | Purpose                                           | Implementation                                    |
| ------------------------------ | ------------------------------------------------- | ------------------------------------------------- |
| **TestController Debug Flow**  | Go extension's test UI builds DebugConfiguration  | Hook into `vscode.debug.startDebugging()` calls   |
| **DebugConfigurationProvider** | Intercept and mutate configurations before launch | Register provider to inject second configuration  |
| **Hierarchical Sessions**      | Nested sessions in CALL STACK view                | Use `parentSession` parameter (VS Code v1.33+)    |
| **Delve Headless Mode**        | Multi-client attach capability                    | `--accept-multiclient` and `--continue` flags     |
| **Remote Attach Config**       | Connect to external dlv server                    | Configure `mode:"remote"`, host, port, remotePath |

### Architecture Benefits

-   **No Go Extension Forking**: Leverages existing extension functionality
-   **Minimal Footprint**: Only injects configuration at the right moment
-   **Seamless Integration**: Preserves existing test binary compilation workflow

## Implementation Specification

### Core Files Structure

```
go-debug-extension/
├─ src/
│  ├─ extension.ts          # Main activation and debug configuration provider
│  ├─ shimLauncher.ts       # Delve server management and port allocation
│  └─ types.ts              # TypeScript type definitions
├─ test/
│  ├─ suite/
│  │  ├─ index.ts          # Test harness setup
│  │  └─ extension.test.ts  # Integration tests
│  └─ fixtures/
│     └─ sample_test.go     # Test fixtures
├─ package.json
└─ tsconfig.json
```

### 1. Shim Launcher Implementation

```typescript
// shimLauncher.ts - Key functionality:
- Dynamic port allocation using getFreePort()
- Spawn dlv process with headless flags
- Environment variable management (HARPOON_DLV_PORT)
- Process lifecycle management
- Error handling and cleanup
```

**Core Features:**

-   **Race-free Port Allocation**: Dynamic port assignment for parallel test runs
-   **Process Management**: Detached spawning with proper cleanup
-   **Multiclient Support**: `--accept-multiclient` keeps server alive between runs
-   **Handshake Prevention**: `--continue` prevents deadlock scenarios

### 2. Debug Configuration Provider

```typescript
// extension.ts - Core logic:
- Register DebugConfigurationProvider for 'go' type
- Intercept 'test' mode configurations only
- Launch shim server before test execution
- Create nested remote-attach configuration
- Handle session lifecycle events
```

**Implementation Flow:**

1. **Intercept Test Launch**: Only modify configurations with `mode: 'test'`
2. **Ensure Shim Server**: Start headless Delve server if not running
3. **Build Child Configuration**: Create remote-attach config for shim
4. **Nest Sessions**: Link child session to parent via `parentSession`
5. **Preserve Parent**: Return original config unchanged

### 3. Remote Attach Configuration

```typescript
const shimCfg: vscode.DebugConfiguration = {
	name: "Attach-Shim",
	type: "go",
	request: "launch", // Go extension treats remote as launch
	mode: "remote",
	host: "127.0.0.1",
	port: dynamicPort,
	remotePath: "${workspaceFolder}",
	showLog: false,
	buildFlags: "-gcflags=all=-N -l",
};
```

## Testing Strategy

### Integration Test Framework

-   **Test Harness**: `@vscode/test-electron` for isolated VS Code instance
-   **Go Extension Integration**: Programmatically install and activate Go extension
-   **Sample Fixtures**: Minimal Go module with test files
-   **Command Execution**: Programmatic `testing.runAll` and `testing.debugAll`

### Test Scenarios

1. **Session Hierarchy Verification**

    - Wait for two `onDidStartDebugSession` events
    - Verify second session's `parentSession.id` equals first session's id
    - Confirm unified call stack display

2. **Shim Connectivity Testing**

    - Send threads DAP request to child session
    - Expect non-empty response
    - Validate connection stability

3. **Breakpoint Functionality**
    - Programmatically set breakpoints in shim code
    - Verify stopped events are triggered
    - Test step-through debugging across boundaries

### CI/CD Pipeline

```json
{
	"scripts": {
		"test": "npm run compile && node ./out/test/runTests.js",
		"compile": "tsc -p .",
		"watch": "tsc -watch -p ."
	}
}
```

**Environment Requirements:**

-   **Platform**: macOS with Go toolchain
-   **Dependencies**: Delve pre-installed
-   **Automation**: GitHub Actions with automatic VS Code download
-   **Matrix Testing**: Multiple VS Code versions (stable/insiders)

## Risk Mitigation & Best Practices

### Performance Considerations

-   **Dynamic Port Allocation**: Prevents conflicts in parallel test execution
-   **Process Cleanup**: Terminate lingering `dlv` processes on session end
-   **Resource Management**: Monitor memory usage and connection limits

### Build Flag Synchronization

-   **Consistent Compilation**: Match `-gcflags=all=-N -l` between test binary and shim
-   **Breakpoint Accuracy**: Ensure debug symbols align across components
-   **Makefile Integration**: Update build processes for debug compatibility

### User Experience Enhancements

-   **Console Management**: Implement `debug.console.collapseIdenticalStackFrames`
-   **Settings Contribution**: Provide configuration options in `package.json`
-   **Error Handling**: Graceful fallbacks for connection failures

## Dependencies & Requirements

### Runtime Dependencies

-   VS Code Extension API (^1.89.0)
-   Go Extension (golang.go) - existing installation
-   Delve debugger - system installation
-   Node.js built-in modules (`child_process`, `net`)

### Development Dependencies

-   `@vscode/test-electron` (^2.4.2)
-   TypeScript (^5.5.0)
-   Mocha test framework
-   ESLint for code quality

### System Requirements

-   **Delve Version**: Support for `--accept-multiclient` flag
-   **VS Code Version**: v1.33+ for hierarchical session support
-   **Go Toolchain**: Compatible with existing Go extension setup

## Success Metrics

### Functional Requirements

1. **Single-Click Debugging**: One Debug Test click instruments both contexts
2. **Unified Stack View**: Both test and shim stacks visible in single tree
3. **Breakpoint Support**: Set and hit breakpoints across boundary
4. **Session Management**: Clean startup and teardown of debug sessions
5. **Performance**: <200ms overhead for debug session establishment

### Quality Metrics

-   **Code Coverage**: >90% test coverage for core functionality
-   **Integration Tests**: All scenarios pass in CI environment
-   **Memory Usage**: <10MB additional memory footprint
-   **Compatibility**: Support for Go extension versions 0.39+

## Deliverables Checklist

### Core Implementation

-   [ ] `extension.ts` - Main extension activation and provider registration
-   [ ] `shimLauncher.ts` - Delve server management utilities
-   [ ] `package.json` - Extension manifest with proper contributions
-   [ ] Debug configuration provider with session nesting

### Testing Suite

-   [ ] Integration test harness with VS Code test runner
-   [ ] Session hierarchy validation tests
-   [ ] Shim connectivity verification tests
-   [ ] Breakpoint functionality tests
-   [ ] CI/CD pipeline configuration

### Documentation & Polish

-   [ ] README.md with installation and usage instructions
-   [ ] Extension settings and configuration options
-   [ ] Troubleshooting guide and known limitations
-   [ ] VS Code Marketplace assets and description

## Future Enhancements

### Advanced Features

-   **Multi-Shim Support**: Debug multiple containerd shims simultaneously
-   **Custom Build Flags**: User-configurable compilation options
-   **Remote Debugging**: Support for debugging on remote systems
-   **Performance Profiling**: Integration with Go profiling tools

### Developer Experience

-   **Configuration Presets**: Common debugging scenarios as templates
-   **Visual Indicators**: Status bar integration for active debug sessions
-   **Logging Integration**: Enhanced log correlation across components
-   **Hot Reload**: Dynamic configuration updates without restart

## Technical Notes

### Implementation Size

-   **Target**: ~150-200 lines of TypeScript
-   **Core Files**: 3 main implementation files
-   **Test Suite**: Comprehensive but lightweight
-   **Total Package**: Minimal extension footprint

### Extension Activation

```json
{
	"activationEvents": ["onDebugInitialConfigurations"],
	"contributes": {
		"debuggers": [
			{
				"type": "go",
				"configurationSnippets": []
			}
		]
	}
}
```

## References & Documentation

-   [VS Code Debug API](https://code.visualstudio.com/api/extension-guides/debugger-extension)
-   [Go Extension Architecture](https://github.com/golang/vscode-go)
-   [Delve Debugger Documentation](https://github.com/go-delve/delve)
-   [VS Code Testing API](https://code.visualstudio.com/api/working-with-extensions/testing-extension)
-   [Hierarchical Debug Sessions](https://code.visualstudio.com/updates/v1_33#_hierarchical-debug-sessions)
