# Go Debug Extension Integration: Cross-Boundary Debugging for Containerd Shim

## Overview

Integrate cross-boundary debugging capabilities into the existing `go-extras` VS Code extension. When debugging Go tests that interact with containerd shims, the extension will automatically launch the containerd shim under a headless Delve server and spawn a nested remote-attach debug session, providing unified debugging across test binary and shim code boundaries.

## Problem Statement

Currently, debugging Go tests that interact with containerd shims requires:

-   Manual setup of multiple debug sessions
-   Complex configuration management
-   Separate debugging contexts for test code and shim code
-   No unified view of the call stack across boundaries

## Proposed Solution

Extend the existing `go-extras` VS Code extension to:

1. Launch containerd shim under a headless `dlv --accept-multiclient` server
2. Automatically spawn a nested "remote-attach" debug session
3. Display both stacks (test binary + shim) in unified tree view
4. Integrate seamlessly with existing CodeLens functionality
5. Require no changes to existing Go extension workflow

## Technical Architecture

### Integration with Existing Go-Extras Extension

The debug functionality will be added to the existing extension in `editors/vscode/src/` alongside the current CodeLens features:

```
editors/vscode/src/
├── extension.ts          # Main extension - add debug configuration provider
├── codelens.ts          # Existing CodeLens functionality
├── debug/               # New debug functionality
│   ├── debugProvider.ts # Debug configuration provider
│   ├── shimLauncher.ts  # Delve server management
│   └── types.ts         # Debug-related type definitions
├── wasm.ts              # Generic WASM wrapper
└── wasm-examples.ts     # WASM usage examples
```

### Key Integration Points

| Component                      | Purpose                                           | Implementation                                    |
| ------------------------------ | ------------------------------------------------- | ------------------------------------------------- |
| **TestController Debug Flow**  | Go extension's test UI builds DebugConfiguration  | Hook into `vscode.debug.startDebugging()` calls   |
| **DebugConfigurationProvider** | Intercept and mutate configurations before launch | Register provider to inject second configuration  |
| **Hierarchical Sessions**      | Nested sessions in CALL STACK view                | Use `parentSession` parameter (VS Code v1.33+)    |
| **Delve Headless Mode**        | Multi-client attach capability                    | `--accept-multiclient` and `--continue` flags     |
| **CodeLens Integration**       | Reference counts with debug context               | Enhance existing CodeLens with debug capabilities |

## Implementation Specification

### 1. Extension Updates

```typescript
// extension.ts - Enhanced activation
export function activate(context: vscode.ExtensionContext) {
	// Existing CodeLens functionality
	const codeLensProvider = new GoExtrasCodeLensProvider();

	// New debug functionality
	const debugProvider = new GoDebugConfigurationProvider();

	// Register both providers
	context.subscriptions.push(
		vscode.languages.registerCodeLensProvider({ scheme: "file", language: "go" }, codeLensProvider),
		vscode.debug.registerDebugConfigurationProvider("go", debugProvider)
	);
}
```

### 2. Debug Configuration Provider

```typescript
// debug/debugProvider.ts - Main debug logic
export class GoDebugConfigurationProvider implements vscode.DebugConfigurationProvider {
	async resolveDebugConfiguration(
		folder: vscode.WorkspaceFolder | undefined,
		config: vscode.DebugConfiguration,
		token?: vscode.CancellationToken
	): Promise<vscode.DebugConfiguration> {
		// Only modify 'test' mode configurations
		if (config.mode !== "test") {
			return config;
		}

		// Launch shim server and create nested configuration
		const shimPort = await this.ensureShimServer();
		const shimConfig = this.createShimAttachConfig(shimPort);

		// Return modified configuration with nested session
		return {
			...config,
			nestedSession: shimConfig,
		};
	}
}
```

### 3. Shim Launcher Implementation

```typescript
// debug/shimLauncher.ts - Delve server management
export class ShimLauncher {
	private static instance: ShimLauncher;
	private shimProcess?: ChildProcess;
	private port?: number;

	async startShimServer(): Promise<number> {
		const port = await this.getFreePort();
		const dlvArgs = [
			"debug",
			"--headless",
			"--listen=:" + port,
			"--accept-multiclient",
			"--continue",
			"./path/to/shim",
		];

		this.shimProcess = spawn("dlv", dlvArgs, {
			detached: true,
			stdio: "ignore",
		});

		this.port = port;
		return port;
	}
}
```

## Integration with Generic WASM Wrapper

The debug functionality can leverage the existing generic WASM wrapper for advanced debugging features:

```typescript
// Example: Using WASM for debug symbol analysis
export class DebugSymbolAnalyzer extends GenericWasmWrapper {
	constructor(outputChannel: vscode.OutputChannel) {
		const config: WasmConfig = {
			moduleName: "debug-analyzer",
			wasmFileName: "debug-analyzer.wasm",
			extensionId: "walteh.go-extras",
		};
		super(outputChannel, config);
	}

	async analyzeSymbols(binaryPath: string): Promise<DebugSymbol[]> {
		return this.callFunction("analyzeSymbols", binaryPath);
	}
}
```

## Package.json Updates

```json
{
	"name": "go-extras",
	"contributes": {
		"debuggers": [
			{
				"type": "go",
				"configurationSnippets": [
					{
						"label": "Go: Debug Test with Shim",
						"description": "Debug Go test with containerd shim support",
						"body": {
							"name": "Debug Test + Shim",
							"type": "go",
							"request": "launch",
							"mode": "test",
							"program": "${workspaceFolder}",
							"enableShimDebugging": true
						}
					}
				]
			}
		],
		"commands": [
			{
				"command": "go-extras.showReferences",
				"title": "Show References"
			},
			{
				"command": "go-extras.debugWithShim",
				"title": "Debug with Shim Support"
			}
		],
		"configuration": {
			"title": "Go Extras",
			"properties": {
				"go-extras.codeLens.enabled": {
					"type": "boolean",
					"default": true,
					"description": "Enable CodeLens functionality"
				},
				"go-extras.debug.shimPath": {
					"type": "string",
					"default": "",
					"description": "Path to containerd shim binary for debugging"
				}
			}
		}
	}
}
```

## Testing Strategy

### Integration with Existing Test Suite

Extend the current test structure in `editors/vscode/`:

```
editors/vscode/test/
├── suite/
│   ├── extension.test.ts      # Existing extension tests
│   ├── codelens.test.ts       # CodeLens functionality tests
│   └── debug.test.ts          # New debug functionality tests
└── fixtures/
    ├── sample_test.go         # Existing test fixtures
    └── shim_test.go           # New shim debugging fixtures
```

### Test Scenarios

1. **CodeLens + Debug Integration**
    - Verify reference counts include debug context
    - Test debug session launching from CodeLens
2. **Session Hierarchy Verification**
    - Wait for two `onDidStartDebugSession` events
    - Verify nested session relationships
3. **Backward Compatibility**
    - Ensure existing CodeLens functionality remains intact
    - Verify non-shim debugging still works

## Build Process Integration

Update the existing build configuration:

```yaml
# Taskfile.yaml - Add debug-specific tasks
version: "3"

tasks:
    build:vscode:
        cmds:
            - cd editors/vscode && bun run build

    test:vscode:
        cmds:
            - cd editors/vscode && bun run test

    debug:setup:
        desc: "Set up debug environment"
        cmds:
            - which dlv || echo "Please install Delve debugger"
            - go version || echo "Please install Go"
```

## Deliverables Checklist

### Core Implementation

-   [ ] Integrate debug provider into existing `extension.ts`
-   [ ] Implement `debug/debugProvider.ts`
-   [ ] Implement `debug/shimLauncher.ts`
-   [ ] Update `package.json` contributions
-   [ ] Maintain backward compatibility with existing CodeLens

### Testing Suite

-   [ ] Extend existing test harness for debug functionality
-   [ ] Debug session hierarchy validation tests
-   [ ] CodeLens integration tests
-   [ ] Regression tests for existing functionality

### Documentation

-   [ ] Update main README.md with debug features
-   [ ] Add debug configuration examples
-   [ ] Document integration with existing features

## Future Enhancements

### Advanced CodeLens Features

-   **Debug Reference Counts**: Show which references are in active debug sessions
-   **Breakpoint CodeLens**: Quick breakpoint setting from reference locations
-   **Call Stack Navigation**: CodeLens showing current execution context

### WASM Integration Opportunities

-   **Debug Symbol Analysis**: Use Go WASM modules for advanced symbol analysis
-   **Performance Profiling**: Integrate profiling data with CodeLens
-   **Custom Debug Visualizations**: WASM-powered debug data visualization

## Success Metrics

1. **Seamless Integration**: Debug features work alongside existing CodeLens without conflicts
2. **Single-Click Experience**: One debug command instruments both test and shim contexts
3. **Unified Stack View**: Both test and shim stacks visible in single debug session
4. **Performance**: <200ms overhead for debug session establishment
5. **Backward Compatibility**: All existing CodeLens features continue to work

This integration approach leverages the existing `go-extras` foundation while adding powerful debug capabilities that complement the reference counting and navigation features already in place.
